namespace: rabbitmq-persistent-volume

rabbitmq:
  defines: runnable
  volumes:
    rabbitmq-data:
      size: <- $persistent-volume-disk-capacity
      kind: <- $persistent-volume-disk-type
      path: <- $volume-data  
  metadata:
    defines: metadata
    name: rabbitmq
    description: RabbitMQ is one of the most popular open source message brokers. From T-Mobile to Runtastic, RabbitMQ is used worldwide at small startups and large enterprises.
    tags: self hosted, message brokers, message queues
    website: https://www.rabbitmq.com/
    source: https://github.com/rabbitmq/rabbitmq-server
    publisher: "monk.io"
    icon: https://www.vectorlogo.zone/logos/rabbitmq/rabbitmq-ar21.png
  services:
    rabbitmq-erl-epmd-port:
      container: rabbitmq
      port: 4369
      protocol: tcp
      host-port: 4369
    rabbitmq-stream-1:
      container: rabbitmq
      port: 5551
      protocol: tcp
      host-port: 5551   
    rabbitmq-stream-2:
      container: rabbitmq
      port: 5552
      protocol: tcp
      host-port: 5552   
    rabbitmq-amqp-1:
      container: rabbitmq
      port: 5672
      protocol: tcp
      host-port: 5672
    rabbitmq-amqp-2:
      container: rabbitmq
      port: 5671
      protocol: tcp
      host-port: 5671 
    rabbitmq-ui-1:
      container: rabbitmq
      port: 15671
      protocol: tcp
      host-port: 15671
    rabbitmq-ui-2:
      container: rabbitmq
      port: 15672
      protocol: tcp
      host-port: 15672                
    rabbitmq-cli:
      container: rabbitmq
      port: 25672
      protocol: tcp
      host-port: 25672    
  containers:
    defines: containers
    rabbitmq:
      image: rabbitmq
      image-tag: <- `${rabbitmq-image}`
      ports:
        - 4369:4369
        - 5551:5551
        - 5552:5552
        - 5672:5672
        - 5671:5671
        - 15672:15672
        - 15671:15671        
        - 25672:25672
      paths:
        - <- `${volume-data}:/var/lib/rabbitmq/`
  files:
    advanced-config:
      container: rabbitmq
      mode: 0644
      path: /etc/rabbitmq/advanced.config
      contents: <<< files/advanced.config
    config:
      container: rabbitmq
      mode: 0644
      path: /etc/rabbitmq/rabbitmq.conf
      contents: <<< files/rabbitmq.conf
    env-config:
      container: rabbitmq
      mode: 0644
      path: /etc/rabbitmq/rabbitmq-env.conf
      contents: <<< files/rabbitmq-env.conf
  variables:
    volume-data:
      type: string
      value: <- `${monk-volume-path}/rabbitmq`
    persistent-volume-disk-capacity:
      type: string
      value: <- $persistent-volume-disk-size
    persistent-volume-disk-type:
      type: string
      value: <- $persistent-volume-disk-kind
    rabbitmq-image:
      value: <- $rabbitmq-image-tag
      type: string     
    RABBITMQ_CONFIG_FILE:
      env: RABBITMQ_CONFIG_FILE
      type: string
      value: "/etc/rabbitmq/rabbitmq.conf"
    RABBITMQ_ADVANCED_CONFIG_FILE:
      env: RABBITMQ_ADVANCED_CONFIG_FILE
      type: string
      value: "/etc/rabbitmq/advanced.config"
    RABBITMQ_CONF_ENV_FILE:
      env: RABBITMQ_CONF_ENV_FILE
      type: string
      value: "/etc/rabbitmq/rabbitmq-env.conf"

nginx:
  defines: runnable
  inherits: nginx
  depends:
    wait-for:
      runnables:
        - rabbitmq-persistent-volume/rabbitmq
      timeout: 30  
  services:
    nginx:
      container: nginx-reverse-proxy
      port: <- `${listen-port}` to-i
      protocol: tcp
      host-port: <- `${listen-port}` to-i
  connections:
    rabbitmq:
      runnable: rabbitmq-persistent-volume/rabbitmq
      service: rabbitmq-ui-2
  files:
    server-def:
      contents: |
        server {
          listen 0.0.0.0:{{ v "listen-port" }};
          location / {
            proxy_set_header X-Real-IP  $remote_addr;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_pass http://{{ v "proxy-target-host" }}:15672;
          }
        }
      mode: 511
      path: /opt/bitnami/nginx/conf/server_blocks/reverse_proxy.conf
      container: nginx-reverse-proxy
  containers:
    defines: containers
    nginx-reverse-proxy:
      image-tag: <- `${nginx-image}`
      image: docker.io/bitnami/nginx
      ports:
      - <- `0.0.0.0:${listen-port}:${listen-port}/tcp`
  variables:
    proxy-target-host:
      value: <- connection-hostname("rabbitmq")
      type: string
    listen-port:
      value: <- $nginx-listen-port
      type: string
    server-name:
      value: <- $rabbitmq-server-name
      type: string
    proxy-target-port:
      value: <- $rabbitmq-node-port
      type: string
    nginx-image:
      value: <- $nginx-image-tag
      type: string